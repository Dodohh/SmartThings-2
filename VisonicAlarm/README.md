# Instructions for setting up Powermax into SmartThings

This code has been written to interface an ESP8266 Wemos D1 R2 into SmartThings. The Arduino code is highly based on the PMax C++ library created by unknown people on https://www.domoticaforum.eu and then integrated onto a Wemos D1 R2 by irekz (https://github.com/irekzielinski/PowerMaxAlarm). I have then modified it and created some extra functions in order to interface with SmartThings.

Some important points to note:
1) The website created by the ESP8266 is currently not password protected (on my to do list eventually). I take no responsibility for your Powermax security!
2) I strongly recommend giving your Wemos a fixed IP address in your router config since otherwise you will need to update your settings whenever the IP changes
3) I am using Arduino Studio 1.6.9 and version 2.3.0 of the ESP8266 board library but I have also included the compiled binary so it saves you the hassle of compiling (details are at the bottom if you want to modify code and try yourself)
4) I have created a custom inactvity motion timeout as Visonic gives no notification that motion has stopped, this will default to 10s after every reboot, but you can configure it through SmartThings.
5) If your Visonic Powermax is complaining about 'comms fail' and 'system trouble' after replacing the Powerlink module then go into installer settings, remove the ip address to send information to (make it 0.0.0.0). Then you need to disconnect the alarm power and its battery. After waiting for 30 seconds you can connect it back up and your alarm will no longer show an error message.
6) The tile about Off/Strobe/Siren/Both is a way of linking the alarm with other actions since using Disarm/ArhHome/Alarm... does not work. Instead you can link them in CoRE with the following lookup - Off=Disarm, Siren=ArmAway, Strobe=ArmHome, Both=Alarm

The key steps to follow when setting up the integrations are as follows:
1) Connect the Wemos to your computer and ensure that it appears in Windows Device Manager as a COM port (serial/USB bridge) - you will need a driver though hopefully it will automatically find it. Take a note of this COM port.
2) Download the bin file and ESPtool.exe into the same folder and open a command prompt to this folder. (once the folder is open in Windows Explorer then hold shift and right click the background - that will allow you to 'Open a command prompt here')
3) Run the following command to flash the Wemos chip (change COMXX to be COM3 if the COM port identified above is #3): "esptool.exe -vv -cd nodemcu -cb 115200 -cp COMXX -ca 0x00000 -cf PowerMaxEsp8266.ino.bin"
4) After the Wemos reboots you will see a WiFi Access Point called "VisonicPowermaxBridge" (it might take a minute to appear), then connect to this access point (no password needed) and navigate to 192.168.4.1 (should be automatic on most phones). Here you should select your own WiFi network (2.4GHz only) by choosing from the menus and adding your password.
5) After this is complete you should see the Wemos connect to your router. Now update the router so that this device is always given the same IP address, this is called a DHCP reservation and without it you may find things stop working after IP addresses change.
6) Navigate to the IP address that the Wemos has been given (take note of it) and you should see a VERY simple dashboard. Also take note of the MAC address listed on this page. You can now disconnect the power and connect to the Powermax alarm.
7) Connect the Wemos to the Powermax alarm. You need four connections: Power, Ground, RX and TX (RX on the Visonic Alarm Panel goes to TX on the Wemos and vice versa) You can see further instructions on the setup from here - https://github.com/irekzielinski/PowerMaxAlarm. I use 12V since it is easy to get from inside the alarm, and plugs into the barrel connector quickly and easily. If using anything else then ensure it matches the wemos at 3V3 or 5V (3.75V is available inside the alarm but is outside the wemos spec of 3.6V max so you will need to drop the voltage with a diode or something - you are also welcome to try with lower voltages but I found 12V was easiest).
8) Check the Wemos is talking to the Powermax alarm by visiting the IP address of the Wemos again and clicking on 'Alarm status' under the JSON endpoint section. You should see the status at the top of the Status page saying disconnected, eventually it should say disarmed and then finally it will show the zones at the bottom of the JSON. If you do not see your zone names in the JSON (as defined in Powermax) then the Wemos has not paired with your Powermax board. The Wemos will auto enroll on Powermax Complete (can take 5 minutes), but on other alarms you will need to force the enroll by going into the Powermax Installer Mode and choosing 'Enroll Powerlink' (again please allow 5 minutes). If you are struggling to get this to work, then try resetting the Wemos by pressing the small button (or disconnecting power) and then waiting again.
9) You should now be able to press Disarm/ArmHome/ArmAway on the Wemos webpage and you should hear your alarm respond! You should also see the full status page with alarm status, pin codes and zone names. Anything not working at this stage will not improve with the following SmartThings steps.
10) Install the two device handlers (Alarm Panel and Multi Zone) into SmartThings. Copy and paste as code, nothing else should need to be changed.
11) Create a device in SmartThings and give it a name of "Visonic Alarm" (or whatever you wish), plus a DNI (Device Network ID) of the MAC address from above (this should be entered in capital letters and without colons i.e. AABBCCDDEEFF). Ensure it uses the Device Handler called 'Visonic Alarm Panel' and other settings as required.
12) Modify the 'Visonic Alarm Panel' device handler to add extra tiles for each zone (line 89 currently shows 12, this should be changed to your number of zones). Add the newly created tiles to the details section (lines 143-144) by adding one 'zoneX' and one 'zonenameX' for each zone. Do not modify the text, it will automatically populate from Powermax, just change the numbers. Ensure you press Save and Publish.
13) Open the new Alarm device ('Visonic Alarm') on SmartThings on your phone and go into settings. Here you should add the IP address for your Wemos, and I also suggest adding a Pre and/or Post name in the settings (e.g. putting Visonic in PreName means that all created zones will have Visonic added at the front of them - this will make them easier to identify in your device list.). I suggest not changing the inactivity timeout yet.
14) Now after saving the settings, stay on the 'Visonic Alarm' page and press 'Refresh' and after 10s press 'Configure'. You should see the device populate information about alarm status and zone names, plus it will also send the SmartThings IP address to Wemos so Wemos can automatically send SmartThings status updates.
15) If you press create devices it should now create individual devices for each of your Visonic Zones that will stay in sync with the tiles on your Visonic Alarm Panel device!

You should finally have a fully linked Visonic Powermax Alarm inside SmartThings and have each of the zones separately broken out!! Woop!!



These are the instructions if you want to compile the code yourself:
1) First set up Arduino Studio and add the Wemos D1 R2 (go to Tools menu, then Boards, then board manager and search for ESP8266)
2) Confirm that you now have the required ESP8266 libraries installed (if not you will need to add them from Sketch/Include Libraries/Manage Libraries - you might need to add them through (File > Preferences > towards the bottom of the window, copy this URL into the “Additional Board Manager URLs” text box: http://arduino.esp8266.com/stable/package_esp8266com_index.json)
3) Connect the Wemos D1 R2 to your computer and ensure the drivers are correct in order for it to show up in Arduino Studio
4) Add the PMAX library folder (5 files) to Arduino studio (the Libraries folder is normally in MyDocuments/Arduino/libraries) - hence it should be libraries/PMax/files-go-here. Alternatively download the 'PMax library folder.zip' file from this Github folder and point Arduino Studio towards this extra Library and it will automatically copy the five files to the right place.
5) Create a sketch and call is whatever you like (mine is called 'PowerMaxEsp8266'). Copy the Arduino code in this file. You can confirm if the PMax library was added successfully because the PMax bit at the top of the file will turn orange (though you might need to restart Arduino Studio first).
6) Ensure you select Wemos D1 R2 as the board, ensure the COM settings are correct. Then compile the code and upload to the Wemos
