# Instructions for setting up Powermax into SmartThings

This code has been written to interface an ESP8266 Wemos D1 R2 into SmartThings. The Arduino code is highly based on the PMax C++ library created by unknown people on https://www.domoticaforum.eu and then integrated onto a Wemos D1 R2 by irekz (https://github.com/irekzielinski/PowerMaxAlarm). I have then modified it and created some extra functions in order to interface with SmartThings.

Some important points to note:
1) The website created by the ESP8266 is currently not password protected (on my to do list eventually). I take no responsibility for your Powermax security!
2) It is currently a bit manual to get all devices set up, hence I strongly advise you make SmartThings and the Wemos have a fixed IP address in your router config.
3) I am using Arduino Studio 1.6.9 and version 2.3.0 of the ESP8266 board library. There is no reason I can think of, why it would not work with another version, but if you are having problems please ensure you use this version.
4) I have created a custom inactvity motion timeout as Visonic gives no notification that motion has stopped, but it is not quite 100% reliable. This is configurable through SmartThings and gets set to the Wemos.
5) If your Visonic Powermax is complaining about 'comms fail' and 'system trouble' after replacing the Powerlink module then go into installer settings, remove the ip address to send information to (make it 0.0.0.0). Then you need to disconnect the alarm power and its battery. After waiting for 30 seconds you can connect it back up and your alarm will no longer show an error message.

The key steps to follow when setting up the integrations are as follows:
1) First set up Arduino Studio and add the Wemos D1 R2 (go to Tools menu, then Boards, then board manager and search for ESP8266)
2) Confirm that you now have the required ESP8266 libraries installed (if not you will need to add them from Sketch/Include Libraries/Manage Libraries - you might need to add them through (File > Preferences > towards the bottom of the window, copy this URL into the “Additional Board Manager URLs” text box: http://arduino.esp8266.com/stable/package_esp8266com_index.json)
3) Connect the Wemos D1 R2 to your computer and ensure the drivers are correct in order for it to show up in Arduino Studio
4) Add the PMAX library folder (4 files) to Arduino studio (the Libraries folder is normally in MyDocuments/Arduino/Libraries). Alternatively download the PMax.zip file from this Github folder and point Arduino Studio towards this extra Library and it will automatically copy the four files to the right place.
5) Create a sketch and call is whatever you like (mine is called 'PowerMaxEsp8266'). Copy the Arduino code in this folder into your sketch and update the settings at the top of the sketch for your personal WiFi details (Everything else should be automatic). These options are listed under the heading '//CHANGE THESE SETTINGS'.
6) Ensure you select Wemos D1 R2 as the board, ensure the COM settings are correct. Then compile the code and upload to the Wemos
7) Connect the Wemos to the Powermax alarm. You need four connections: Power, Ground, RX and TX (RX on the Visonic Alarm Panel goes to TX on the Wemos and vice versa) You can see further instructions on the setup from here - https://github.com/irekzielinski/PowerMaxAlarm. I use 12V since it is easy to get from inside the alarm, and plugs into the barrel connector quickly and easily. If using 3V3 from the alarm then this is fine and you can connect directly to the Wemos, but if using 5-24V then ensure you connect via the barrel connector.
8) Check the Wemos is connected to your WiFi by looking at your router and getting the IP address. Set the router to give a fixed IP address to the Wemos if possible
9) Check the Wemos is talking to the Powermax alarm by visiting the IP address of the Wemos and clicking 'Alarm status' under the JSON endpoint section. You should see the status at the top of the Status page saying disconnected, eventually it should say disarmed and then finally it will show the zones at the bottom of the JSON. If you do not see your zone names in the JSON (as defined in Powermax) then the Wemos has not paired with your Powermax board. The Wemos will auto enroll on Powermax Complete (can take 5 minutes), but on other alarms you will need to force the enroll by going into the Powermax Installer Mode and choosing 'Enroll Powerlink' (again please allow 5 minutes). If you are struggling to get this to work, then try resetting the Wemos by pressing the small button and then waiting again.
10) You should now be able to press Disarm/ArmHome/ArmAway on the Wemos webpage and you should hear your alarm respond! Anything not working at this stage will not improve with the following SmartThings steps.
11) Install the VisonicAlarmPanel device handler by copying and pasting in from Code.
12) Modify the VisonicAlarmPanel device handler to add extra tiles for each zone (line 81 currently shows 12, this should be changed to your number of zones). Add the newly created tiles to the details section (lines 108-109) by adding one 'zoneX' and one 'zonenameX' for each zone. Do not modify the text, it will automatically populate from Powermax, just change the numbers. Ensure you press Save and Publish.
13) Create a device for your Visonic Alarm and name it as you wish (I suggest 'Visonic Alarm Panel'). In the Device Network ID paste in the Wemos MAC address, this should be entered in capital letters and without colons (i.e. AABBCCDDEEFF). Once created press configure and type in the IP address for your Wemos (that is the only settings that is required).
14) Open SmartThings on your phone and go to the newly created 'Visonic Alarm Panel' and press 'Configure'. You should see the device populate information about alarm status and zone names, plus it will also send the SmartThings IP address to Wemos so Wemos can automatically send SmartThigns status updates.
You can stop here if you want and you now have control of your Powermax Alarm from SmartThings, plus some status information. Alternatively continue to get separate zones in SmartThings (they will be easier to interface with things like CoRE)
15) Install the VisonicMultiZone device handler and the VisonicZoneManager smart app. Remember to Save and Publish.
16) Create a device for each zone that you have, and ensure it is setup to use the VisonicMultiZone device handler. Set the name to whatever you wish (I suggest 'Visonic Zone Name' where zone name is the name inside the Powermax). Set the device network ID to be 'visoniczoneX' (where X is the actual zone number in Powermax) - You can get this information from the Visonic Alarm Panel and the name must be 'visoniczoneX' (e.g. visoniczone1 or visoniczone4)
17) Now add the Smart App (you can do this through the App by going to the Automations tab and then selecting SmartApps at the top, followed by 'Add a SmartApp' and choose from 'My Apps' at the bottom.
18) Inside the SmartApp, first select the Alarm panel and then choose each of your devices/zones before giving it a name (I suggest 'Visonic Zone Manager') and pressing Save

You should finally have a fully linked Visonic Powermax Alarm inside SmartThings and have each of the zones separately broken out!! Woop!!
